version: "3.8"

services:
  # =============================================
  # Service PHP/Apache avec CSWeb
  # =============================================
  php:
    build:
      context: './php/'
      args:
        PHP_VERSION: ${PHP_VERSION}
    networks:
      - frontend
      - backend
    volumes:
      - ${CSWEB_ROOT}/:/var/www/html/
    ports:
      - "80:80"
    depends_on:
      - mysql
      - postgres
    container_name: csweb_php
    environment:
      - PHP_INI_SCAN_DIR=/usr/local/etc/php/conf.d:/usr/local/etc/php/custom.d

  # =============================================
  # MySQL - Base de données principale CSWeb
  # =============================================
  mysql:
    image: mysql:${MYSQL_VERSION:-8.0.33}
    restart: always
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    networks:
      - backend
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${DB_NAME}"
      MYSQL_USER: "${DB_USERNAME}"
      MYSQL_PASSWORD: "${DB_PASSWORD}"
    container_name: csweb_mysql
    command: --default-authentication-plugin=mysql_native_password --log_bin_trust_function_creators=1

  # =============================================
  # PostgreSQL - Pour breakout des dictionnaires
  # =============================================
  postgres:
    image: postgres:15-alpine
    restart: always
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
    networks:
      - backend
    environment:
      POSTGRES_USER: "${PG_USERNAME:-cspro}"
      POSTGRES_PASSWORD: "${PG_PASSWORD:-password}"
      POSTGRES_DB: "${PG_DATABASE:-cspro_data}"
    container_name: csweb_postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USERNAME:-cspro}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================
  # SQL Server - Optionnel pour organisations nécessitant SQL Server
  # =============================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    restart: always
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - backend
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}"
      MSSQL_PID: "Developer"  # Edition: Developer, Express, Standard, Enterprise
    container_name: csweb_sqlserver
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

  # =============================================
  # phpMyAdmin - Interface pour MySQL
  # =============================================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: "${DB_ROOT_PASSWORD}"
    ports:
      - '8080:80'
    networks:
      - frontend
      - backend
    depends_on:
      - mysql
    container_name: csweb_phpmyadmin

  # =============================================
  # pgAdmin - Interface pour PostgreSQL
  # =============================================
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: "${PGADMIN_EMAIL:-admin@csweb.local}"
      PGADMIN_DEFAULT_PASSWORD: "${PGADMIN_PASSWORD:-admin}"
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "8081:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - frontend
      - backend
    depends_on:
      - postgres
    container_name: csweb_pgadmin

  # =============================================
  # Redis - Cache et gestion des sessions
  # =============================================
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - backend
    container_name: csweb_redis
    command: redis-server --appendonly yes

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  postgres_data:
    driver: local
  sqlserver_data:
    driver: local
  pgadmin_data:
    driver: local
  redis_data:
    driver: local
